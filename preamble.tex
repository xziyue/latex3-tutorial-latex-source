\input{font_pdflatex.tex}
\usepackage[english]{babel}
\usepackage{metalogo}
\usepackage{tcolorbox}
\usepackage{booktabs}
\usepackage{microtype}
\usepackage{expl3}
\usepackage{mdframed}
\usepackage{chngcntr}
\usepackage{etoolbox}
\usepackage{adjustbox}
\usepackage{supertabular}
\usepackage{makecell}
\usepackage{tikz}
\usepackage{ragged2e}
\usepackage{float}
\usepackage{array}
\usepackage{xcolor}
%\usepackage[breaklinks,colorlinks,pdfa]{hyperref}
\usepackage[breaklinks]{hyperref}
\usepackage[capitalise]{cleveref}


\tcbuselibrary{listings, minted, skins, breakable, xparse, hooks}

% a quick command for LaTeX3
\newcommand*{\liii}{\LaTeX3}


% using custom lexer for highlighting LaTeX3 syntax
\newcommand*{\liiilexer}{tex_lexer.py:Tex3Lexer -x}
% other code highliting setup
\newmintinline[inltex]{\liiilexer}{breaklines, breakanywhere, fontfamily=DejaVuSansMono-TLF}
\newmintinline[inlpy]{python}{fontfamily=DejaVuSansMono-TLF}
\newmintinline[inlpl]{text}{}

% set the style of the list of examples
% https://tex.stackexchange.com/questions/86711/tcolorbox-list-of-listings
\newcommand{\ListOfCodeExampleName}{List of Examples}
\makeatletter
\newcommand{\ListOfCodeExample}{\section*{\ListOfCodeExampleName}\@starttoc{CodeExample}}
\makeatother

% the counter for numbered code examples
\newcounter{codeexample}
\counterwithin{codeexample}{section}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% this segment of code is to implement arbitrary code
% cross-referencing within the article
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\makeatletter
\ExplSyntaxOn
\bool_new:N \g_lst_line_ref_bool
\tl_new:N \g_lst_label_tl
\tl_new:N \l_lst_tmpa_tl
\tl_new:N \l_lst_tmpb_tl
\prop_new:N \g_lst_index_prop

\cs_set:Npn \__lst_write_aux:n #1 {
    \immediate\write\@auxout{#1}
}

\newcommand{\EnableLstRef}{\bool_gset_true:N \g_lst_line_ref_bool}
\newcommand{\DisableLstRef}{\bool_gset_false:N \g_lst_line_ref_bool}
\newcommand{\SetLstRefLabel}[1]{\tl_gset:Nn \g_lst_label_tl {#1}}
\newcommand{\LstPutLookup}[1]{
    \tl_set:Nn \l_lst_tmpb_tl {
       \string\expandafter\string\gdef\string\csname\space @@lst-lookup-#1\string\endcsname{\TheLstCounter}
    }
    \exp_args:Nx \__lst_write_aux:n \l_lst_tmpb_tl
}
\newcommand{\LstUseLookup}[1]{
    \cs_if_exist:cTF {@@lst-lookup-#1} {
        \use:c {@@lst-lookup-#1}
    } {
        ?
    }
}


\cs_set:Npn \__lst_render_line: {
    \textcolor[rgb]{0.5,0.5,0.5}{
    \ttfamily\scriptsize
    \arabic{FancyVerbLine}
    }
}

\cs_set:Npn \__lst_make_hypertarget:nn #1 #2{
   \raisebox{1em}{\hypertarget{#1}{}}#2 
}

\renewcommand{\theFancyVerbLine}{
    \bool_if:NTF \g_lst_line_ref_bool {
        \tl_set:Nx \l_lst_tmpa_tl {\arabic{FancyVerbLine}}
        \exp_args:Nx \__lst_make_hypertarget:nn {\g_lst_label_tl-\l_lst_tmpa_tl}{
            \__lst_render_line:
        }
    }{
        \__lst_render_line:
    }

}

\int_new:N \g_lst_counter_int
\newcommand{\AddLstCounter}{\int_gincr:N \g_lst_counter_int}
\newcommand{\TheLstCounter}{\int_use:N \g_lst_counter_int}

% user command to cross reference a line in the lising
% #1: listing name
% #2: line number
% #3 (optional): would output a range of lines from #2 to #3 if present
\DeclareDocumentCommand{\lref}{mmo}{
    \IfValueTF{#3}{Lines}{Line}~\hyperlink{#1-#2}{
        \LstUseLookup{#1}:
        \IfValueTF{#3}{#2-#3}{#2}
    }
}

% user command to cross referenec a listing
\DeclareDocumentCommand{\lstref}{m}{
    Listing~\hyperlink{#1-1}{
        \LstUseLookup{#1}
    }
}

\ExplSyntaxOff
\makeatother
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% basic style for examples
\tcbset{
  codesample/.style={
    enhanced,
    breakable,
    beforeafter skip=3ex,
    listing engine=minted,
    minted language=\liiilexer,
    fontlower=\sffamily\small,
    minted options={
      fontsize=\fontsize{9}{9},
      autogobble,
      breaklines,
      obeytabs,
      tabsize=2,
      linenos,
      numbersep=2mm,
      xleftmargin=4mm,
      fontfamily=DejaVuSansMono-TLF
    },
    fonttitle=\normalfont,
    colback=white,
    colframe=black!60,
    boxrule=0.8pt,
    left=1mm,
    right=1mm,
    top=0.5mm,
    bottom=0.5mm,
    before upper pre={\AddLstCounter},
    overlay unbroken and last={
        \node[font=\sffamily\bfseries\scriptsize, anchor=south east] at (frame.south east) {\color[rgb]{0.5,0.5,0.5} \TheLstCounter};
    }
  }
}


% listing only example
\DeclareTCBListing{latexsample**}{!o}{
    codesample,
    listing only,
    IfValueTF={#1}
    {
        before upper app={\EnableLstRef\SetLstRefLabel{#1}\LstPutLookup{#1}},
        after app={\DisableLstRef}
    }
    {}
}

% anonymous example
\DeclareTCBListing{latexsample*}{!o}{
    codesample,
    IfValueTF={#1}
    {
        before upper app={\EnableLstRef\SetLstRefLabel{#1}\LstPutLookup{#1}},
        after app={\DisableLstRef}
    }
    {}
}

%\newtcblisting{latexsample*}{
%  codesample
%}

% listing of any language
\newtcblisting{codesample}[1]{
  codesample,
  listing only,
  minted language=#1
}



\makeatletter
% better URL line breaking
\g@addto@macro{\UrlBreaks}{\UrlOrds}

%\newcommand{\inlcolorbox}[2]{
%    \bgroup
%    %\setlength{\fboxsep}{0pt}
%    \colorbox{blue!30}{#2}
%    \egroup
%}

%\patchcmd{\minted@inputpyg@inline}{\colorbox}{\inlcolorbox}{}{\GenericError{}{cannot patch minted}{}{}}
%\let\old@minted@inputpyg@inline\minted@inputpyg@inline
%\renewcommand{cmd}{def}

\crefname{codeexample}{Example}{Examples}
\newcommand{\exfullref}[1]{Example \ref{#1} (\lstref{#1})}

\makeatother