\input{font_pdflatex.tex}
\usepackage[english]{babel}
\usepackage{metalogo}
\usepackage{tcolorbox}
\usepackage{booktabs}
\usepackage{microtype}
\usepackage{expl3}
\usepackage{mdframed}
\usepackage{chngcntr}
\usepackage{etoolbox}
\usepackage{adjustbox}
\usepackage{supertabular}
\usepackage{makecell}
\usepackage{tikz}
\usepackage{ragged2e}
\usepackage{float}
\usepackage{array}
\usepackage{xcolor}
\usepackage{datetime2}
\usepackage[scale=0.9]{tgheros}

\ExplSyntaxOn
\file_if_exist:nTF{USE_SHELL_ESCAPE}
{
    \file_if_exist:nTF{MINTED_FINALIZE}
    {
        \iow_term:n {=====~Document~is~compiled~in~finalization~mode~=====}
        \usepackage[finalizecache,cachedir={minted-frozen}]{minted}
    }
    {
        \iow_term:n {=====~Document~is~compiled~in~development~mode~=====}
        \usepackage{minted}
    }
}
{
    \iow_term:n {=====~Document~is~compiled~in~submission~mode~=====}
    \usepackage[frozencache,cachedir={minted-frozen}]{minted}
}
\ExplSyntaxOff


%\usepackage[breaklinks,colorlinks,pdfa]{hyperref}
\usepackage[breaklinks]{hyperref}
\usepackage[capitalise]{cleveref}


\tcbuselibrary{listings, minted, skins, breakable, xparse, hooks}

% a quick command for LaTeX3
\newcommand*{\LT}{\texorpdfstring{\LaTeX}{LaTeX}}
\newcommand*{\LTT}{\texorpdfstring{\LaTeX3}{LaTeX3}}
\let\liii\LTT

\renewcommand{\MintedPygmentize}{./my_pygmentize}
% other code highliting setup
\newmintinline[inltex]{tex_lexer.py:Tex3Lexer}{breaklines, breakanywhere, fontfamily=DejaVuSansMono-TLF,style=colorful}
\newmintinline[inlpy]{python}{fontfamily=DejaVuSansMono-TLF,style=colorful}
\newmintinline[inlpl]{text}{}

% set the style of the list of examples
% https://tex.stackexchange.com/questions/86711/tcolorbox-list-of-listings
\newcommand{\ListOfCodeExampleName}{List of Examples}
\makeatletter
\newcommand{\ListOfCodeExample}{\section*{\ListOfCodeExampleName}\@starttoc{CodeExample}}
\makeatother

% the counter for numbered code examples
\newcounter{codeexample}
\counterwithin{codeexample}{section}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% this segment of code is to implement arbitrary code
% cross-referencing within the article
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\makeatletter
\ExplSyntaxOn
\bool_new:N \g_lst_line_ref_bool
\tl_new:N \g_lst_label_tl
\tl_new:N \l_lst_tmpa_tl
\tl_new:N \l_lst_tmpb_tl

\newcommand{\SetLstRefLabel}[1]{\tl_gset:Nn \g_lst_label_tl {#1}}


\cs_set:Npn \__lst_render_line: {
    \textcolor[rgb]{0.5,0.5,0.5}{
    \ttfamily\scriptsize
    \arabic{FancyVerbLine}
    }
}

\cs_set:Npn \__lst_make_hypertarget:nn #1 #2{
   \raisebox{1em}{\hypertarget{#1}{}}#2 
}

\renewcommand{\theFancyVerbLine}{
    \tl_if_empty:NTF \g_lst_label_tl {
        \__lst_render_line:
    }{
        \tl_set:Nx \l_lst_tmpa_tl {\arabic{FancyVerbLine}}
        \exp_args:Nx \__lst_make_hypertarget:nn {\g_lst_label_tl-\l_lst_tmpa_tl}{
            \__lst_render_line:
        }
    }
}

% user command to cross reference a line in the listing
% #1: listing name
% #2: line number
% #3 (optional): would output a range of lines from #2 to #3 if present
% \DeclareDocumentCommand{\lref}{mmo}{
%     \IfValueTF{#3}{Lines}{Line}~\hyperlink{#1-#2}{
%         \IfValueTF{#3}{#2-#3}{#2}
%         @
%         \LstUseLookup{#1}
%     }
% }

\seq_new:N \l_lst_line_seg_seq
\tl_new:N \l_lst_first_line_tl
\DeclareDocumentCommand{\lref}{mm}{
    \regex_split:nnN {-} {#2} \l_lst_line_seg_seq
    \int_case:nnF {\seq_count:N \l_lst_line_seg_seq}
    {
        {1} {Line~}
        {2} {Lines~}
    }
    {
        \GenericError{}{\string\lref~received~invalid~arguments}{}{}
    }

    \seq_pop_left:NN \l_lst_line_seg_seq \l_lst_first_line_tl

    \exp_args:Nx \hyperlink{#1-\l_lst_first_line_tl}
    {
        #2
    }
    @\ref{#1}
}



\bool_new:N \ExportCurrentCodeExample
\let\SetBoolTrue\bool_gset_true:N
\let\SetBoolFalse\bool_gset_false:N
\ExplSyntaxOff
\makeatother
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% basic style for examples
\gdef\CurrentExampleTitle{}
\tcbset{
  codesample/.style={
    enhanced,
    breakable,
    beforeafter skip=3ex,
    listing engine=minted,
    minted language=tex_lexer.py:Tex3Lexer,
    fontlower=\sffamily\small,
    minted options={
      fontsize=\fontsize{9}{9},
      autogobble,
      breaklines,
      breakanywhere,
      obeytabs,
      tabsize=2,
      linenos,
      numbersep=2mm,
      xleftmargin=4mm,
      fontfamily=DejaVuSansMono-TLF,
      style=colorful
    },
    fonttitle=\normalfont,
    colback=white,
    colframe=black!60,
    boxrule=0.8pt,
    left=1mm,
    right=1mm,
    top=0.5mm,
    bottom=0.5mm,
    before upper app={\SetBoolTrue\ExportCurrentCodeExample\SetLstRefLabel{}},
  }
}


\tcbset{
    noexec/.style={listing only},
    examplelabel/.style args={#1}{
        before upper app={\SetLstRefLabel{#1}},
    },
    exampletitle/.style args={#1}{
        title={Example \thecodeexample: #1}
    },
    noexport/.code={
        \SetBoolFalse\ExportCurrentCodeExample
    }
}



\makeatletter
\ExplSyntaxOn

% options for controlling example export globally
\bool_new:N \g_lst_export_example_bool
\bool_gset_false:N \g_lst_export_example_bool
\cs_new:Npn \ExportExamples
{
    \bool_gset_true:N \g_lst_export_example_bool
}

\cs_set:Npn \__doc_write:Nn #1#2 {
    \immediate\write#1{#2}
}


\cs_generate_variant:Nn \__doc_write:Nn {Nx}
\cs_set_eq:NN \MyWriteA \__doc_write:Nn
\cs_set_eq:NN \MyWriteB \__doc_write:Nx
\cs_set_eq:NN \PCTSGN \c_percent_str

\cs_set:Npn \__doc_open_out:Nn #1#2 {
    \immediate\openout#1 #2\relax
}
\cs_generate_variant:Nn \__doc_open_out:Nn {Nx}
\cs_set_eq:NN \MyOpenOut \__doc_open_out:Nx

\tl_new:N \l_doc_tmpa_tl
\tl_new:N \ExampleFilename
\cs_set:Npn \UpdateExampleFilename {
    \tl_set_eq:NN \l_doc_tmpa_tl \thecodeexample
    \regex_replace_all:nnN {\.} {-} \l_doc_tmpa_tl
    \tl_set_eq:NN \ExampleFilename \l_doc_tmpa_tl
}

\iow_new:N \g_lst_example_iow
\ior_new:N \g_lst_example_ior
\tl_new:N \l_lst_now_time_tl

\cs_set:Npn \@@DoLaTeXExample #1 {

    \refstepcounter{codeexample}

    \tl_gset:Nx \CurrentExampleTitle {Example~\thecodeexample}

    % load the listing file
    \exp_args:Nx \tcbinputlisting { 
        codesample,
        listing~file={temp-example.vrb},
        title={\exp_not:V \CurrentExampleTitle}
        \exp_not:V #1
    }

    % add labels
    \tl_if_empty:NF \g_lst_label_tl
    {   
        \iow_term:x {=== \g_lst_label_tl : \thecodeexample}
        \exp_args:NV \label \g_lst_label_tl
    }

    % export example
    \bool_if:nT {\g_lst_export_example_bool && \ExportCurrentCodeExample}
    {
        \UpdateExampleFilename
        \iow_open:Nn \g_lst_example_iow {examples/example-\ExampleFilename.tex}
        \ior_open:Nn \g_lst_example_ior {temp-example.vrb}

        \tl_if_empty:NTF \CurrentExampleTitle
        {
            \iow_now:Nx \g_lst_example_iow {\c_percent_str\space  This~is~Example~\thecodeexample\space ~exported~by~\jobname.tex}
        }
        {
            \iow_now:Nx \g_lst_example_iow {\c_percent_str\space   This~is~exported~Example~\thecodeexample\space ~(\CurrentExampleTitle)~exported~by~\jobname.tex}
        }
        \iow_now:Nx \g_lst_example_iow {\c_percent_str\space   Do~not~modify~this~file~directly;~the~changes~will~not~be~reflected~in~the~source~document}

        \tl_set:Nx \l_lst_now_time_tl {\DTMNow}
        \regex_replace_all:nnN {\c{relax}} {} \l_lst_now_time_tl
        \iow_now:Nx \g_lst_example_iow {\c_percent_str\space Export~timestamp:~\l_lst_now_time_tl}
        
        \ior_str_map_inline:Nn \g_lst_example_ior
        {
            \iow_now:Nn \g_lst_example_iow {##1}
        }
        \ior_close:N \g_lst_example_ior
        \iow_close:N \g_lst_example_iow
    }

    \gdef\CurrentExampleTitle{}
}

\ExplSyntaxOff


% change fancyvrb environment so that we can use our own key-val options
\def\@@CurLaTeXExArgs{}
\def\FV@EnvironmentNew#1#2{%
  \def\FV@KeyValues{#1}%
  \def\@@CurLaTeXExArgs{}
  \catcode`\^^M=\active
  \@ifnextchar[%
    {\catcode`\^^M=5 \FV@GetKeyValues{\let\@@CurLaTeXExArgs\FV@KeyValues\def\FV@KeyValues{#1}\@nameuse{FVB@#2}}}%
    {\catcode`\^^M=5 \@nameuse{FVB@#2}}}

\def\FVB@latexsample{%
  \@bsphack
  \begingroup
    \FV@UseKeyValues
    \FV@DefineWhiteSpace
    \def\FV@Space{\space}%
    \FV@DefineTabOut
    \def\FV@ProcessLine{\immediate\write\FV@OutFile}%
    \immediate\openout\FV@OutFile temp-example.vrb\relax
    \let\FV@FontScanPrep\relax
%% DG/SR modification begin - May. 18, 1998 (to avoid problems with ligatures)
    \let\@noligs\relax
%% DG/SR modification end
    \FV@Scan}
\def\FVE@latexsample{\immediate\closeout\FV@OutFile\endgroup\@esphack\@@DoLaTeXExample\@@CurLaTeXExArgs}


\@namedef{latexsample}{\FV@EnvironmentNew{}{latexsample}}%
\@namedef{endlatexsample}{\@nameuse{FVE@latexsample}}%


\makeatother


% \newtcbinputlisting{\inputlatexsample}[2]{
%   codesample,
%   title=\GenExampleTitle{#1},
%   listing file={#2}
% }

% \newcommand{\GenExampleTitle}[1]{%
%     %\refstepcounter{codeexample}
%     \hspace*{0.5em}
%     Example \thecodeexample:~#1
%     \addcontentsline{CodeExample}{subsection}{\protect\numberline{\thecodeexample}#1}
% }

% %TODO: fix the environment when exporting!

% \else

% \newcommand{\GenExampleTitle}[2]{%
%     \refstepcounter{codeexample}
%     \IfValueT{#2}{\label{#2}}
%     \hspace*{0.5em}
%     Example \thecodeexample:~#1
%     \addcontentsline{CodeExample}{subsection}{\protect\numberline{\thecodeexample}#1}
% }

% \DeclareTCBListing{latexsample}{m!o}{
%     codesample,
%     title=\GenExampleTitle{#1}{#2},
%     IfValueTF={#2}
%     {
%         before upper app={\EnableLstRef\SetLstRefLabel{#2}\LstPutLookup{#2}},
%         after app={\DisableLstRef}
%     }
%     {}
% }

%\newtcblisting{latexsample}[1]{
%  codesample,
%  title=\GenExampleTitle{#1}
%}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ExplSyntaxOn
\newcommand*{\GenAnonTitle}[1]{
    \refstepcounter{codeexample}
    \tl_if_empty:nTF {#1}
    {
        Example~\thecodeexample
    }
    {
        Example~\thecodeexample: 
    }
}

\ExplSyntaxOff


%\newtcblisting{latexsample*}{
%  codesample
%}

% listing of any language
\newtcblisting{codesample}[1]{
  codesample,
  listing only,
  minted language=#1
}



\makeatletter
% better URL line breaking
\g@addto@macro{\UrlBreaks}{\UrlOrds}

%\newcommand{\inlcolorbox}[2]{
%    \bgroup
%    %\setlength{\fboxsep}{0pt}
%    \colorbox{blue!30}{#2}
%    \egroup
%}

%\patchcmd{\minted@inputpyg@inline}{\colorbox}{\inlcolorbox}{}{\GenericError{}{cannot patch minted}{}{}}
%\let\old@minted@inputpyg@inline\minted@inputpyg@inline
%\renewcommand{cmd}{def}

\crefname{codeexample}{Example}{Examples}

\makeatother